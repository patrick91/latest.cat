name: Preview New Versions

on:
  pull_request:
    paths:
      - 'software.yml'

jobs:
  preview-versions:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Get changed software
        id: changes
        run: |
          # Get the diff of software.yml
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }} -- software.yml > software.diff

          # Extract new software slugs
          NEW_SLUGS=$(grep "^+.*slug:" software.diff | sed 's/^+.*slug: //' | tr '\n' ' ')
          echo "new_slugs=$NEW_SLUGS" >> $GITHUB_OUTPUT

          if [ -z "$NEW_SLUGS" ]; then
            echo "No new software detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "New software detected: $NEW_SLUGS"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Fetch versions for new software
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          uv sync
          uv run python -m cli fetch-versions

      - name: Generate version preview
        if: steps.changes.outputs.has_changes == 'true'
        id: preview
        run: |
          cat > generate_preview.py << 'PYTHON_SCRIPT'
          import sqlite3
          import sys

          # Read new slugs from environment
          new_slugs = "${{ steps.changes.outputs.new_slugs }}".split()

          if not new_slugs:
              sys.exit(0)

          conn = sqlite3.connect('db.sqlite')
          cursor = conn.cursor()

          output = ["## ðŸ” Version Changes Preview", ""]

          # Get versions for new software
          new_software_found = False
          for slug in new_slugs:
              cursor.execute("""
                  SELECT s.name, s.slug, v.major, v.minor, v.patch
                  FROM Software s
                  LEFT JOIN Version v ON v.id = s.latest_version_id
                  WHERE s.slug = ?
              """, (slug.strip(),))

              row = cursor.fetchone()
              if row:
                  if not new_software_found:
                      output.append("### ðŸ†• New Software Added")
                      output.append("")
                      output.append("| Software | Slug | Latest Version |")
                      output.append("|----------|------|----------------|")
                      new_software_found = True

                  name, slug, major, minor, patch = row
                  if major is not None:
                      version = str(major)
                      if minor is not None:
                          version += f".{minor}"
                      if patch is not None:
                          version += f".{patch}"
                      output.append(f"| {name} | `{slug}` | `{version}` |")
                  else:
                      output.append(f"| {name} | `{slug}` | _No version found_ |")

          if not new_software_found:
              output.append("_No new software versions found_")

          output.append("")
          output.append("---")
          output.append("_This preview shows the latest versions for newly added software._")

          with open('comment.md', 'w') as f:
              f.write('\n'.join(output))

          conn.close()
          PYTHON_SCRIPT

          python generate_preview.py
          cat comment.md

      - name: Comment on PR
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Version Changes Preview')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
